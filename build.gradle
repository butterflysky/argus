plugins {
    id 'base'
    id 'fabric-loom' version '1.11-SNAPSHOT' apply false
    id 'org.jetbrains.kotlin.jvm' version '2.1.20' apply false
    id 'org.jetbrains.kotlin.plugin.serialization' version '2.1.20' apply false
    id 'idea'
    id 'eclipse'
}

ext {
    serializationVersion = "1.6.3"
    javacordVersion = project.findProperty("javacord_version") ?: "3.8.0"
    slf4jVersion = "2.0.13"
}

subprojects {
    apply plugin: 'java'
    apply plugin: 'org.jetbrains.kotlin.jvm'
    apply plugin: 'org.jetbrains.kotlin.plugin.serialization'
    apply plugin: 'idea'
    apply plugin: 'eclipse'

    group = project.findProperty("maven_group") ?: "dev.butterflysky"
    version = project.findProperty("mod_version") ?: "0.0.1"

    repositories {
        maven {
            name = 'Fabric'
            url = 'https://maven.fabricmc.net/'
        }
        mavenCentral()
    }

    java {
        sourceCompatibility = JavaVersion.VERSION_21
        targetCompatibility = JavaVersion.VERSION_21
        withSourcesJar()
    }

    tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
        kotlinOptions.jvmTarget = "21"
    }
}

configure(subprojects.findAll { it.name == "fabric" }) {
    apply plugin: 'fabric-loom'

    dependencies {
        minecraft "com.mojang:minecraft:${project.minecraft_version}"
        mappings "net.fabricmc:yarn:${project.yarn_mappings}:v2"
        modImplementation "net.fabricmc:fabric-loader:${project.loader_version}"
        modImplementation "net.fabricmc.fabric-api:fabric-api:${project.fabric_version}"
        modImplementation "net.fabricmc:fabric-language-kotlin:${project.fabric_kotlin_version}"
        implementation project(":common")
    }

    loom {
        splitEnvironmentSourceSets()
        decompilers {
            vineflower { }
        }
    }

    tasks.withType(JavaCompile).configureEach {
        options.release = 21
    }
}

project(":common") {
    dependencies {
        implementation "org.javacord:javacord:${rootProject.ext.javacordVersion}"
        implementation "org.jetbrains.kotlinx:kotlinx-serialization-json:${rootProject.ext.serializationVersion}"
    }
}

project(":neoforge") {
    // Placeholder: will add NeoForge specifics in a later task.
}

tasks.named("build") {
    dependsOn(subprojects.collect { it.tasks.named("build") })
}
